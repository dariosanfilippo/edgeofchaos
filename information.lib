// INFORMATION PROCESSING

ba = library("basics.lib");
f2 = library("filters2.lib");
ip = library("information.lib");
ma = library("maths.lib");
m2 = library("maths2.lib");

// zero-crossing detection
zc(x) = x*x' : <(0);

// zero-crossing rate
zcr(x, window) = zc(x) : f2.lp1p(_, window);

// infinitely fast attack and adjustable release
peak_env(in, release) = abs(in) :   max(_, _)
                                    ~ *(release : m2.rt60);

// hold peak for a time specified in seconds
peak_hold(in, release) = in : ba.peakholder(release*ma.SR);

// envelope following
env_fol(in, window) = in : abs : lp1p(_, window);

// root mean square measurement using lowpass
rms(in, window) = in <: * : f2.lp1p(_, window) : sqrt;

// RMS with fourth-order LP
rms4(in, window) = in <: * : seq(i, 4, _,
                                       window : f2.lp1p) : sqrt;

// spectral energy (RMS) difference at a splitting point (Hz)
spec_bal(in, cf, window) =  in ,
                            cf : f2.crossover <:   (   _ ,
                                                       window : rms : *(-1)) ,
                                                   (   _ ,
                                                       window : rms) : +;

// spectral tendency (weighted mean)
spec_ten(in, window) =  (   (   in ,
                                _ ,
                                window : spec_bal) ,
                            (   in ,
                                window : rms) :  m2.div : *(window) : /(ma.SR) : f2.clip_int(_, 0, 1)) 
                        ~ (pow(4) : *(m2.ny));

// noisiness
noisiness(in, window) = spec_ten(in, window) <: (  in, 
                                                   _ : zcr : logscale),
                                                (_ : ma.inv) : m2.delta : abs : f2.lp1p(_, window)
with {
      logscale(x) = log(x*(10-1)+1)/log(10);
};

// roughness
roughness(in, window) = in <:  (   (   rms4(_, 100),
                                       .01 : m2.delta : abs),
                                   window : f2.lp1p),
                               rms(_, window) : m2.div;
